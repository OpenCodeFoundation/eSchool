pool:
  vmImage: "ubuntu-latest"
trigger:
  paths:
    include:
      - src/Services/Enrolling/*
      - build/azure-devops/enrolling-api/*
pr:
  paths:
    include:
      - src/Services/Enrolling/*
      - build/azure-devops/enrolling-api/*
steps:
  - task: DockerCompose@0
    displayName: Build
    inputs:
      dockerComposeCommand: "build enrolling.api"
      dockerComposeFile: docker-compose.yml

  - task: DockerCompose@0
    displayName: Unit Tests
    inputs:
      dockerComposeCommand: "run enrolling.api.test"
      dockerComposeFile: docker-compose-test.yml
      additionalDockerComposeFiles: docker-compose-test.override.yml

  - task: DockerCompose@0
    displayName: Functional Tests
    inputs:
      dockerComposeCommand: "run enrolling.api.functional-test"
      dockerComposeFile: docker-compose-test.yml
      additionalDockerComposeFiles: docker-compose-test.override.yml

  - task: PublishTestResults@2
    displayName: Publish test results
    inputs:
      testResultsFormat: "VSTest"
      testResultsFiles: "**/*.xml"
      searchFolder: "$(Build.ArtifactStagingDirectory)"
      publishRunAttachments: true

  - task: PublishCodeCoverageResults@1
    displayName: Publish test coverage
    inputs:
      codeCoverageTool: "cobertura" # Options: cobertura, jaCoCo
      pathToSources: $(System.DefaultWorkingDirectory)/src/Services/Enrolling/
      summaryFileLocation: "$(Build.ArtifactStagingDirectory)/*/coverage.cobertura.xml"
